name: E2E Test Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-e2e-tests:
    name: Verify PR includes E2E tests
    runs-on: ubuntu-latest
    outputs:
      e2e_tests_found: ${{ steps.changed-files.outputs.e2e_tests_found }}
      src_files_changed: ${{ steps.changed-files.outputs.src_files_changed }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history to compare with base branch
      
      - name: Get changed files
        id: changed-files
        run: |
          # Get the list of changed files compared to the base branch
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          echo "Comparing $BASE_SHA...$HEAD_SHA"
          
          # Get all changed files
          CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA)
          echo "$CHANGED_FILES"
          
          # Check if any e2e test files were added or modified
          E2E_FILES=$(echo "$CHANGED_FILES" | grep -E '^e2e/[0-9]{3}-.*\.spec\.ts$' || true)
          
          if [ -n "$E2E_FILES" ]; then
            echo "e2e_tests_found=true" >> $GITHUB_OUTPUT
            echo "✅ E2E test files found:"
            echo "$E2E_FILES"
          else
            echo "e2e_tests_found=false" >> $GITHUB_OUTPUT
            echo "❌ No E2E test files found"
          fi
          
          # Check if any source files (src/) were changed
          SRC_FILES=$(echo "$CHANGED_FILES" | grep -E '^src/.*\.(ts|tsx|js|jsx|svelte)$' || true)
          
          if [ -n "$SRC_FILES" ]; then
            echo "src_files_changed=true" >> $GITHUB_OUTPUT
            echo "Source files changed:"
            echo "$SRC_FILES"
          else
            echo "src_files_changed=false" >> $GITHUB_OUTPUT
            echo "No source files changed"
          fi
      
      - name: Check for E2E tests requirement
        run: |
          E2E_FOUND="${{ steps.changed-files.outputs.e2e_tests_found }}"
          SRC_CHANGED="${{ steps.changed-files.outputs.src_files_changed }}"
          
          echo "E2E tests found: $E2E_FOUND"
          echo "Source files changed: $SRC_CHANGED"
          
          # If source files changed, E2E tests are required
          if [ "$SRC_CHANGED" = "true" ] && [ "$E2E_FOUND" = "false" ]; then
            echo "::error::❌ This PR modifies source code but does not include E2E tests."
            echo "::error::Please add E2E tests following E2E_TEST_GUIDELINES.md"
            echo "::error::See AGENT_PROBLEM_STATEMENT.md for the required E2E test checklist."
            exit 1
          fi
          
          if [ "$E2E_FOUND" = "true" ]; then
            echo "::notice::✅ E2E tests found in this PR"
          else
            echo "::notice::ℹ️ No E2E tests required (no source code changes)"
          fi
      
      - name: Validate E2E test structure
        if: steps.changed-files.outputs.e2e_tests_found == 'true'
        run: |
          echo "Validating E2E test structure..."
          
          # Get base and head SHA
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          # Get changed e2e test files
          E2E_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA | grep -E '^e2e/[0-9]{3}-.*\.spec\.ts$' || true)
          
          VALIDATION_FAILED=false
          
          for TEST_FILE in $E2E_FILES; do
            echo "Checking $TEST_FILE..."
            
            # Extract test directory (e.g., e2e/001-character-selection)
            TEST_DIR=$(dirname "$TEST_FILE")
            TEST_NAME=$(basename "$TEST_DIR")
            
            # Check for README.md
            if [ ! -f "$TEST_DIR/README.md" ]; then
              echo "::error file=$TEST_FILE::Missing README.md in $TEST_DIR"
              VALIDATION_FAILED=true
            fi
            
            # Check for screenshots directory
            SCREENSHOT_DIR="$TEST_DIR/${TEST_NAME}.spec.ts-snapshots"
            if [ ! -d "$SCREENSHOT_DIR" ]; then
              echo "::error file=$TEST_FILE::Missing screenshot directory $SCREENSHOT_DIR"
              VALIDATION_FAILED=true
            else
              # Check if screenshots exist
              SCREENSHOT_COUNT=$(find "$SCREENSHOT_DIR" -name "*.png" | wc -l)
              if [ "$SCREENSHOT_COUNT" -eq 0 ]; then
                echo "::error file=$TEST_FILE::No baseline screenshots found in $SCREENSHOT_DIR"
                VALIDATION_FAILED=true
              else
                echo "✅ Found $SCREENSHOT_COUNT baseline screenshots in $SCREENSHOT_DIR"
              fi
            fi
            
            # Check test file uses createScreenshotHelper
            if ! grep -q "createScreenshotHelper" "$TEST_FILE"; then
              echo "::warning file=$TEST_FILE::Test does not use createScreenshotHelper()"
            fi
            
            # Check test file has programmaticCheck
            if ! grep -q "programmaticCheck" "$TEST_FILE"; then
              echo "::warning file=$TEST_FILE::Test may be missing programmatic checks"
            fi
            
            # Check for waitForTimeout (should not be used)
            if grep -q "waitForTimeout" "$TEST_FILE"; then
              echo "::error file=$TEST_FILE::Test uses waitForTimeout() - use specific waits instead"
              VALIDATION_FAILED=true
            fi
          done
          
          if [ "$VALIDATION_FAILED" = "true" ]; then
            echo "::error::E2E test validation failed. See errors above."
            echo "::error::Refer to E2E_TEST_GUIDELINES.md for proper test structure."
            exit 1
          fi
          
          echo "✅ E2E test structure validation passed"

  run-e2e-tests:
    name: Run E2E tests
    runs-on: ubuntu-latest
    needs: check-e2e-tests
    if: needs.check-e2e-tests.outputs.e2e_tests_found == 'true' || github.event.pull_request.base.ref == 'main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Install dependencies
        run: bun install
      
      - name: Install Playwright browsers
        run: bunx playwright install --with-deps chromium
      
      - name: Build application
        run: bun run build
      
      - name: Run E2E tests
        run: bun run test:e2e
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
      
      - name: Upload test screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results/
          retention-days: 30
