name: Cleanup PR Preview

on:
  pull_request:
    types: [closed]

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Check if gh-pages branch exists
        id: check-branch
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.repos.getBranch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                branch: 'gh-pages'
              });
              core.setOutput('exists', 'true');
            } catch (error) {
              if (error.status === 404) {
                core.setOutput('exists', 'false');
                console.log('gh-pages branch does not exist');
              } else {
                console.error(`Failed to check gh-pages branch: ${error.message}`);
                throw error;
              }
            }

      - name: Checkout gh-pages branch
        if: steps.check-branch.outputs.exists == 'true'
        uses: actions/checkout@v4
        with:
          ref: gh-pages

      - name: Remove PR preview directory
        if: steps.check-branch.outputs.exists == 'true'
        run: |
          PR_DIR="pr-${{ github.event.pull_request.number }}"
          if [ -d "$PR_DIR" ]; then
            rm -rf "$PR_DIR"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add .
            git commit -m "Remove PR #${{ github.event.pull_request.number }} preview" || echo "No changes to commit"
            git push
            echo "Cleaned up preview for PR #${{ github.event.pull_request.number }}"
          else
            echo "No preview directory found for PR #${{ github.event.pull_request.number }}"
          fi

      - name: Skip cleanup - no gh-pages branch
        if: steps.check-branch.outputs.exists == 'false'
        run: echo "No gh-pages branch exists, skipping cleanup"
